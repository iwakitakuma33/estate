# 不動産分析ツール - Google Apps Script版

このプロジェクトは、不動産投資の分析を行うGoogle Apps Scriptアプリケーションです。

## 特徴

- **スプレッドシート直接対応**: Googleスプレッドシートを開いてメニューから直接分析可能
- **シンプルなUI**: サイドバーから簡単に分析を実行
- **リアルタイム処理**: 結果が同じスプレッドシートに即座に反映

## セットアップ手順

### 1. claspのインストール

```bash
npm install -g @google/clasp
```

### 2. Google Apps Scriptにログイン

```bash
clasp login
```

### 3. スプレッドシートにバインドされたGASプロジェクトを作成

**方法A: 既存のスプレッドシートにバインド（推奨）**

1. 分析したいスプレッドシートを開く
2. 「拡張機能」→「Apps Script」を選択
3. スクリプトIDをコピー
4. `.clasp.json`の`scriptId`に設定

**方法B: claspで新規作成**

```bash
cd gas
clasp create --type standalone --title "不動産分析ツール"
```

作成されたスクリプトIDを`.clasp.json`の`scriptId`に設定してください。

※ standalone版の場合、後でスプレッドシートにバインドする必要があります。

### 4. コードをプッシュ

```bash
clasp push
```

### 5. スプレッドシートにバインド

1. 分析したいスプレッドシートを開く
2. 「拡張機能」→「Apps Script」を選択
3. `clasp push`でコードをプッシュ、または手動でコピー&ペースト
4. スプレッドシートを再読み込み
5. 「不動産分析」メニューが自動的に表示される

## 使用方法

### 方法1: サイドバーから実行（推奨）

1. 分析したいスプレッドシートを開く
2. 「不動産分析」メニューから「サイドバーを開く」を選択
3. サイドバーの「分析を実行」ボタンをクリック
4. 結果が同じスプレッドシートの「結果」シートに出力される

### 方法2: メニューから直接実行

1. 分析したいスプレッドシートを開く
2. 「不動産分析」メニューから「分析を実行」を選択
3. 結果が同じスプレッドシートの「結果」シートに出力される

## 必要なスプレッドシート/Excelファイルの形式

### 「入力」シート

- A列に「HEADER」と記載（1行目）
- 各種パラメータのキー名をA列に記載
  - `bd_price`: 物件価格
  - `ld_price`: 土地価格
  - `bd_room_count`: 部屋数
  - `et_years`: 購入後経過年数
  - など
- 「HEADER_JP」列を作成（日本語の項目名）
- HEADER_JP列の右側にデータを入力

### 「結果」シート

- 同様の形式で出力項目を定義
- 分析結果が自動的に書き込まれる

## 使用ライブラリ

- **zod** (v3.22.4): データバリデーション用 - CDNから読み込み
- **math.js** (v12.4.1): 数式計算用 - CDNから読み込み
- **xlsx** (v0.18.5): Excelファイル処理用 - CDNから読み込み

## ファイル構成

- `Code.ts`: メイン処理（GASのエントリーポイント）
- `estate.ts`: 不動産データモデルとスキーマ定義
- `analyzer.ts`: 分析ロジック
- `sidebar.html`: スプレッドシート用サイドバー
- `appsscript.json`: GASプロジェクト設定
- `tsconfig.json`: TypeScript設定

## 主な機能

### onOpen()
スプレッドシートを開いたときに「不動産分析」メニューを追加

### showSidebar()
サイドバーを表示

### analyzeCurrentSpreadsheet()
現在開いているスプレッドシートを分析し、結果を「結果」シートに書き込む

## 注意事項

- GASの実行時間制限（6分）に注意してください
- 大量のデータを処理する場合は、処理を分割する必要があります
- スプレッドシートの共有設定により、他のユーザーがアクセスできない場合があります

## トラブルシューティング

### エラー: "HEADER,et_yearsが見つかりませんでした"
- スプレッドシートの「入力」シートにHEADERとet_yearsが正しく設定されているか確認してください

### エラー: "HEADERJPが見つかりませんでした"
- HEADER行にHEADER_JPが設定されているか確認してください

### メニューが表示されない
- スプレッドシートを再読み込みしてください
- Apps Scriptのトリガーが正しく設定されているか確認してください

### 分析が完了しない
- GASの実行時間制限（6分）を超えている可能性があります
- データ量を減らすか、処理を分割してください

## 開発

### ローカルで編集してプッシュ

```bash
# コードを編集
vim gas/Code.ts

# GASにプッシュ
clasp push

# ブラウザで確認
clasp open
```

### ログの確認

```bash
clasp logs
```

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。
